---
title: "Bulk_Density"
author: "Harnay"
date: "2025-01-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load Libraries
```{r}
library(tidyverse)
library(gridExtra)

```

Load data and metadata
```{r}
#load wax data
wax.data <- read.csv("Data/test_bulk_density_data.csv", header=TRUE)
colnames(wax.data) <- c("Sample.ID", "DW.clean.g", "DW.wax.g", "BW.wax.g", "Temperature.C", "Notes")
wax.data$Sample.ID <- as.character(wax.data$Sample.ID)

species.id <- read.csv("Data/test_Haplotype_data.csv", header=TRUE)
species.id$Species <- factor(species.id$Species)
species.id$Sample.ID <- as.character(species.id$Sample.ID)

metadata <- read.csv("/Users/hputnam/MyProjects/Pocillopora-Lagoon-Abundance/Data/POC_ID_RA_list.csv", header=TRUE) %>%
  select(c("Number", "Stage", "Timing", "Site", "Transect"))

colnames(metadata) <- c("Sample.ID", "Stage", "Timing", "Site", "Transect")
metadata$Sample.ID <- as.character(metadata$Sample.ID)

```

#Calculate surface area (Volume enclosed) using the standard curve
```{r}

#View the range of DW.clean.g
range(wax.data$DW.clean.g)
boxplot(wax.data$DW.clean.g)
hist(wax.data$DW.clean.g)
max(wax.data$DW.clean.g)

#View the range of DW.wax.g
range(wax.data$DW.wax.g)
boxplot(wax.data$DW.wax.g)
hist(wax.data$DW.wax.g)
max(wax.data$DW.wax.g)

wax.data <- wax.data %>%
  mutate(Vol.enc = DW.wax.g - BW.wax.g) %>%
  mutate(Bulk.Density = DW.clean.g/Vol.enc)

#check the range of bulk density values
#1.44 - 2.22 reported 10.7717/peerj.3191
range(wax.data$Bulk.Density)
boxplot(wax.data$Bulk.Density)
hist(wax.data$Bulk.Density)
max(wax.data$Bulk.Density)

```

Set species colors
```{r}

species_colors <- c("P. tuahiniensis" = "#D55E00",
                    "P. meandrina" = "pink",
                    "P. meandrina P. grandis" = "#0072B2",
                    "P. verrucosa" = "#E69F00",
                    "P. grandis" = "#56B4E9",
                    "P. effusa" = "#009E73",
                    "P. acuta" = "#e63946")

```

Plot by species and site
```{r}
data <- left_join(wax.data, species.id, by= "Sample.ID")
data <- left_join(data, metadata, by= "Sample.ID")

data$Species <- factor(data$Species, levels = c("P. tuahiniensis", 
                                                "P. meandrina", 
                                                "P. meandrina P. grandis", 
                                                "P. verrucosa", 
                                                "P. grandis", 
                                                "P. effusa", 
                                                "P. acuta"))

str(data)

bulk.density.plot.raw <- data %>%
  ggplot(aes(x = Site, y = Bulk.Density, color = Species)) +  # Add 'color = Species' to map colors to the Species variable
  geom_point() +  # Plot the data points
  scale_color_manual(values = species_colors) +  # Apply the manual color scale
  facet_wrap(~ Species) +  # Facet by Species
  theme_bw()+
  labs(title="All Raw Data",
    x = "Species",
    y = "Bulk Density g/cm2"
  )  

bulk.density.plot.raw

```

```{r}

#remove max outlier
filtered_data <- data %>%
  filter(Bulk.Density != max(data$Bulk.Density, na.rm = TRUE))

bulk.density.plot.outlier.removed <- filtered_data %>%
  ggplot(aes(x = Site, y = Bulk.Density, color = Species)) +  # Add 'color = Species' to map colors to the Species variable
  geom_point() +  # Plot the data points
  scale_color_manual(values = species_colors) +  # Apply the manual color scale
  facet_wrap(~ Species) +  # Facet by Species
  theme_bw()+
  labs(title="Outlier Removed",
    x = "Species",
    y = "Bulk Density g/cm2"
  )  

bulk.density.plot.outlier.removed


```
View a single site
```{r}
#remove max outlier
filtered_data <- data %>%
  filter(Bulk.Density != max(data$Bulk.Density, na.rm = TRUE)) %>%
  filter(Site == "S14")

bulk.density.plot.S14 <- filtered_data %>%
  ggplot(aes(x = Species, y = Bulk.Density, color = Species)) +  # Add 'color = Species' to map colors to the Species variable
  geom_point() +  # Plot the data points
  scale_color_manual(values = species_colors) +  # Apply the manual color scale
  theme_bw()+
  labs(title="Single Site - Site 14",
    x = "Species",
    y = "Bulk Density g/cm2"
  )

bulk.density.plot.S14

```

plot to pdf
```{r}
# Save the plots to a PDF in one column
pdf("Output/BW.plots.pdf", height = 12, width = 6) # Set dimensions for the PDF
grid.arrange(bulk.density.plot.raw,
             bulk.density.plot.outlier.removed,
             bulk.density.plot.S14, ncol = 1) # Arrange in 1 column
dev.off() # Close the PDF device

```